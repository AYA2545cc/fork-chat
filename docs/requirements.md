# チャットアプリケーション 要件定義書

## 1. プロジェクト概要

### 1.1. 目的
GoogleのGemini APIを利用し、過去の対話をどの時点からでも分岐させることが可能な、個人利用向けのWebチャットアプリケーションを開発する。

### 1.2. コア機能
* 標準的なチャット機能
* 会話履歴の任意の時点からの分岐機能
* 会話全体の分岐構造を可視化するツリービュー機能
* PDFや画像ファイルの内容を理解した上での対話機能

## 2. 機能要件

### 2.1. チャット機能
* ユーザーとAI (Gemini) が一対一で対話を行う。
* AIからの返信は、リアルタイムストリーミング（一文字ずつ表示される形式）で描画される。

### 2.2. 会話の分岐機能
* **操作**: 各メッセージ（ユーザー、AI問わず）をPCでは「右クリック」、スマートフォンでは「長押し」することで、コンテキストメニューを表示する。
* **実行**: コンテキストメニュー内の「この時点から分岐して続ける」ボタンを押下すると、そのメッセージを親として新しい対話を開始できる。

### 2.3. 俯瞰ビュー（ツリー表示）
* **目的**: 一つの会話における分岐の全体像を俯瞰するために、専用のビューを設ける。
* **表示**:
    * 会話はツリー構造で表示される。
    * 各ノードは「ユーザーの発言」とし、その内容はGemini APIによって自動要約された短いテキストとする。
    * 各ノードのサイズは均一とする。
    * `React Flow`等のライブラリを使用し、ドラッグやズームが可能なインタラクティブなUIを目指す。

### 2.4. マルチモーダル機能（ファイル添付）
* ユーザーはチャット入力時に、PDFや画像ファイルを添付できる。
* 添付されたファイルはGoogle File APIを通じてアップロードされ、Geminiモデルはその内容を理解した上でユーザーの質問に回答する。

### 2.5. ユーザー認証
* 個人利用を前提とするため、ユーザー認証機能、ログイン機能は設けない。

## 3. 非機能要件

### 3.1. UI/UXデザイン
* Google Geminiの公式Webアプリを参考に、クリーンでモダンなデザインを採用する。
* PC・スマートフォンの両方で快適に利用できるレスポンシブデザインとする。

### 3.2. パフォーマンス
* AIからの応答はWebSocketを利用したストリーミング形式とし、ユーザーの待ち時間を体感的に短縮する。
* UIの操作は軽快で、ストレスなく動作すること。

### 3.3. 実行環境
* アプリケーション全体（フロントエンド、バックエンド、DB）をDocker Composeで一元管理する。
* ユーザー自身のPC上でDockerコンテナを起動して使用する。
* 外部からのアクセスは、`Tailscale`等のVPNトンネリングサービスを利用することを想定する。クラウドサービスへのデプロイは必須としない。

### 3.4. データ管理
* 会話履歴、分岐構造、ファイル情報などの全データは、永続化される単一のSQLiteデータベースファイルに保存する。
* データベースファイルはDockerのボリュームマウント機能を利用して、ホストマシン（ユーザーのPC）上に永続化する。

## 4. 技術アーキテクチャ

### 4.1. システム構成図

```plaintext
[User's Browser (PC/Mobile)] via Tailscale
       ↑
       | (HTTP / WebSocket)
       ↓
+-------------------------------------------------------------+
| Docker on User's PC                                         |
|                                                             |
|  +---------------------+        +-------------------------+ |
|  | Frontend (Next.js)  |  <=>   | Backend (FastAPI)       | |
|  | Port: 3000          |        | Port: 8000              | |
|  +---------------------+        +-------------------------+ |
|                                       ↑      |              |
|                                       |      | (Gemini API) |
|                                       |      ↓              |
|  +---------------------------------+  |  [Google Cloud]    |
|  | data/ (Mounted Volume)          |  |                    |
|  |  - chat_database.sqlite         |--+                    |
|  |  - uploaded_files/              |                      |
|  +---------------------------------+                      |
|                                                             |
+-------------------------------------------------------------+
```

### 4.2. 使用技術スタック

| カテゴリ | 技術・ライブラリ | 役割 |
| :--- | :--- | :--- |
| **フロントエンド** | Next.js (React) | UI/UXの構築 |
| **UIコンポーネント**| Tailwind CSS + Shadcn/ui | モダンなUIデザインの実装 |
| **ツリービュー** | React Flow | 俯瞰ビューの描画 |
| **バックエンド** | FastAPI (Python) | APIサーバー、ビジネスロジック |
| **データベース** | SQLite | データ永続化 |
| **DB操作 (ORM)** | SQLAlchemy | PythonによるDB操作 |
| **リアルタイム通信**| WebSocket | AIレスポンスのストリーミング |
| **マルチモーダル** | Google AI Python SDK (File API) | ファイルのアップロードと解析 |
| **実行環境** | Docker Compose | アプリケーション全体のコンテナ管理 |
